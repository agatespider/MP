# 성능 테스트 기본

## 1. 성능 테스트 유형
기획, 분석, 설계, 개발, 테스트 단계에서 해야할 성능 테스트 단계

### 1.1 [성능] 시스템 성능 목표 달성 여부 평가 (설계, 개발, 테스트)
TPS, 응답시간, 자원 사용률의 만족 여부를 평가하기 위한 기본적인 테스트

### 1.2 [과부하] 한계 성능 평가, 부족 자원 확인 (설계, 개발, 테스트)
과부하 상황에서 시스템의 성능 저하 패턴을 분석해 한계 성능을 평가, 한계 상황에서 성능 저하나 장애의 주 요인이 되는 자원들을 확인한다.

### 1.3 [안정성] 응답시간, 자원 사용률 안정성 평가 (설계, 개발, 테스트)
적정 부하에서 24시간 이상 지속적으로 테스트를 수행해 응답시간, 자원 사용율이 초기와 같이 일정한지 확인, 처리 데이터 누적과, 메모리 누수가 발생 할 수 있어 미리 확인하고 조치하기 위해 수행하는 테스트

### 1.4 [최적화] 성능 개선 (설계, 개발, 테스트)
어플리케이션 튜닝과 시스템 구성 요소를 수정해 가면서 테스트. 영향도를 정확하게 평가하기 위해서 한번 수행시 한가지 항목만 적용 해야한다.

### 1.5 [가용성] 일부 시스템 장애시 서비스 가능성 평가 (설계, 개발, 테스트)
서버나 네트워크 장비등에서 장애가 발생했을 때 처리 데이터 누락없이 지속적으로 서비스가 가능한지 여부를 평가한다.

### 1.6 [실사용자] 실제 성능 평가, 추가 개선 대상 도출 (테스트)
실 사용자가 일정 시간 동안 일상 업무 처리 패턴에 따라 신규 시스템을 사용함으로써 실제 오픈시의 성능을 미리 확인하고 추가 개선 대상을 도출한다.

### 1.7 [벤치마크] 소프트웨어나 하드웨어 비교 평가 (기획)
여러 제품에 대해 성능 우수성을 비교 평가하기 위해 수행하는 테스트, 시스템 구축전 제품 선정을 위해 실시한다.

### 1.8 [파일럿] 설계 아키텍처 검증 (분석, 설계)
실제 본개발이 들어가기 전에 설계된 아키텍처의 기능과 성능을 검증하는 테스트, 중요기능별로 몇 가지 업무를 미리 개발해서 검증하는 과정을 통해 아키텍처를 개선하며, 개발자에게 제공할 각종 설치 가이드, 개발 가이드, 성능 가이드 등을 보완한다.

파일럿 테스트시에 성능, 안정성, 과부하 테스트등이 진행된다.

## 2. 성능 테스트 구성 요소

### 2.1 부하 모델
업무 시나리오, 테스트 데이터, 적용 부하에 대한 종합 적인 설계 모델 성능 테스트 핵심 부분.

### 2.2 업무 시나리오
부하 발생에 사용할 업무의 종류와 비중을 설계한 시나리오, 최대 부하 시 실제 발생한 업무 비중을 기준으로 도출

예를 들면 A 업무 40%, B 업무 30%, C 업무 20%, D/E업무 5%씩 처럼 TPS기준으로 업무 시나리오 작성, 업무 비중이 작아도 누락하지 말아야 한다.

### 2.3 테스트 데이터
데이터는 DB안의 시스템 데이터와 화면에서 요청시 발생하는 스크립트 데이터로 나뉘며 각각의 양에따라 성능 측정 결과가 달라진다.

### 2.4 적용 부하
업무 시나리오 비중을 유지하면서 발생시킬 업무 TPS를 의미한다. 현재나 미래에 발생할 최대 부하시 TPS를 적용 부하로 보통 설정한다. 또한 평상시부하, 최대 부하, 최대부하의 150% 과부하를 측정한다.

### 2.5 테스트 환경
테스트는 기본적으로 운영 환경에서 진행하는 것이 원칙이다.

### 2.6 평가 기준
TPS, 응답시간, 자원 사용율에 대한 목표 성능 달성 여부 판단. 고객과 부하 모델에 관해 사전협의가 필요.

### 2.7 측정 항목
성능 평가 기준에 대한 만족 여부를 판단할 수 잇는 평가용 측정 항목과 성능 저하시 발생 위치와 원인을 판단할 분석용 측정자료. 측정 항목이 결정나면 방안 수립 및 도구 설치등의 후속작업이 따른다.

### 2.8 부하 발생기
성능 테스트 도구를 사용해서 부하 모델에 따라 가상 사용자가 업무를 수행하는 장비를 뜻하며 예전엔 서버급 장비를 부하 발생기로 사용했지만 요새는 노트북으로도 쓴다.

### 2.9 가상 사용자
부하 발생기내에서 실 사용자가 업무를 수행하는 것처럼 시나리오에 따라 테스트 대상 시스템에 서비스 요청을 보내고 응답을 받는 역할을 하는 것을 가상 사용자라 한다. 보통 부하 발생기에서 한개의 프로세스나 스레드가 된다.

### 2.10 테스트 스크립트
가상의 사용자가 수행할 업무를 코드형태로 작성한 스크립트 파일.

## 3. 성능 테스트시 주의사항
성능 테스트에서 이상이 없다 하더라도 운영시점에 문제가 발생 할 수도 있다. 이런 불상사를 막기 위해 고려해야 할 상황은 성능 테스트의 여러 제반 환경과 조건이 실제 운영 환경과 동일해야 한다는 점이다.

### 3.1 테스트 데이터
#### 3.1.1 시스템 데이터 (데이터 대상 DB)
데이터 양이 운영과 동일한지 확인한다. 데이터 소량시 디스크 I/O가 일어나야 하는데 모두 메모리에 적재되서 빠르게 보이기 때문이다.

#### 3.1.2 스크립트 데이터 (입력용 데이터)
스크립트 데이터양을 작게 하지 말자. 데이터 소량시 실재 사용 데이터들이 메모리에 캐쉬되므로써 빠르게 보이기 때문이다.

#### 3.1.3 초기 데이터 제로 테이블
초기 데이터가 적을 경우 빠르지만 데이터가 쌓여가면서 성능저하가 발생한다. 운영하면서 건수가 크게 증가하는 테이블은 DBA에게 요청해 데이터가 쌓여있을 때의 통계정보로 테이블 통계정보를 변경해달라고 요청해야한다.

### 3.2 화면 처리시간
대부분의 성능 테스트 도구는 클라이언트 측 요청에서 응답까지 받는 시간을 측정한다. 이유는 클라이언트를 담당할 부하 발생기가 1대당 많게는 100명이상의 가상 사용자 역할을 수행하는데 부하 발생기의 리소스를 사용하게 되므로 클라이언트에서 랜더링관련 요소들이나 클라이언트 로직은 그런 자원소모로 인해서 제데로 측정이 되지 않기 때문이다.

만약 클라이언트에서 동작하는 로직이 복잡하거나 계산해야 한다면 중요로직에 대해 별도로 화면의 처리 시간에 대해서 계산을 하고 서버 처리시간과 같이 비교를 해야한다.

### 3.3 네트워크
성능 테스트시 부하 발생기가 연결돼어 있는 스위치를 바로 백본 스위치에 연결해서 테스트를 수행하는 경우가 많다. 이는 네부 네트워크와 서버 중심으로 처리시간을 측정하고, 사실상 인터넷망과 같은 외부 네트워크는 제외하기 위해서 이다.

근데 실제 사용자가 원거리에 있거나 네트워크 환경이 열악한 곳에 있다면 응답시간은 증가 할것이며, 네트워크 패킷 손실에 따라 재전송을 할 경우 정상적인 응답시간보다 더 느려질 것이다.

결국 네트워크 전송이 지연되면서 응답양이 많아야 할 경우 스레드를 다 써버려서 큐잉이 발생한다. 그러면 전체적인 사용자가 성능 저하를 경험을 하게 된다. (응답시간이 느려짐)

즉 실 사용자가 누구인지 어디에 위치하는지 고려해야하고 그에 따른 측정 방식을 도입해야 한다.

### 3.4 가상 사용자 특성
보통 HP로드러너(LoadRunner)의 경우 웹 서비스의 기본 타임 아웃은 2분으로 설정되어 있다. 하지만 실사용자는 20-30초면 못견디고 다시 재요청을 보낸다. 성능 테스트에선 모르겟지만 실 운영시점에서는 동일 사용자에 의한 서비스 반복 요청이 이루어져서 대량의 큐잉이 발생할 수 있으므로 실고객의 상태를 확인 후 그에 맞는 성능 테스트를 해야한다.

그리고 또 다른 예는 WAS가 40개의 인스턴스로 구성되어 RR(Round Robin)방식으로 요청을 분배 처리하는데 성능 테스트시에 1-2분에 한번꼴로 TPS가 절반으로 떨어지는 케이스가 발생했다.

이 원인은 Full GC가 발생시 7초정도 서비스가 멈추면서 TPS가 떨어진것인데 인스턴스가 여러개다 보니 전체적으로 1-2분씩 TPS가 떨어진것처럼 보인것이였다.
 
실제 부하는 사용자가 생각할 시간에 대해서 고려하지 않고 최대한 서비스를 많이 호출하도록 한 것이 문제 였는데 실제 응답시간이 작을 수록 가상 사용자가 많은 서비스를 호출하고 FULL GC가 자주 발생하고 또한 RR이다 보니 LC(Least Connection)방식과 다르게 순차적으로 서비스 처리를 수행하다보니 FULL GC된 인스턴스에 처리 요청이 가고 큐잉이 발생하면서 발생되는 문제였었다.
  
### 3.5 업무 시나리오
업무시나리오는 세세하게 다 준비를 해야한다. 예를 들어 회원가입시 아이디 중복 체크같은것을 넣지 않는데 다 넣어야 한다.

그리고 서버쪽에서 수행되는 배치나 후속작업도 모두 포함 시켜야 한다. 당연하게도 배치가 CPU를 사용하고 있어서 CPU가 20%사용중일때와 배치가 돌지 않아 CPU자원이 1%정도만 사용될때랑 당연히 성능차이는 날 수 밖에 없기 때문이다.

### 3.6 대상 업무와 성능 개선
실제 업무는 20%법칙에 따라 가장 중요한 업무 20%를 테스트 하는게 원칙인데 이렇게 해서 테스트를 통과하더라도 서비스가 안정적일 것이라 판단하면 오산이다.

전혀 생각도 못햇던 업무에서 메모리 누수나 대량 데이터 조회로 인해서 성능 저하나 장애가 발생 할 수 있다. 성능 테스트란 시스템 오픈을 위한 최소한의 기준이고 오픈 이후 지속적 모니터링과 지속적인 수정 작업을 진행해야 한다.