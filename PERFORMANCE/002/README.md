# 성능 이론

# 1. 기초 성능 법칙

    서비스 요청 간격 = 응답시간 + 다음 요청까지의 생각시간
    동시 사용자 수 = 요청 사용자 수 + 비요청 사용자 수
    
### 1.1 리틀의 법칙
   
    처리량(TPS) 
    = 서비스 처리 건수 / 측정 시간(초)
    = 요청 사용자 수 / 평균 응답시간(초)
    = 동시 사용자 수 / 서비스 요청 간격(초)
               
    큐의 평균 서비스 대기 건수 = 평균 큐 처리량 * 평균 대기 시간
    서비스 수행 중인 평균 건수 = 평균 큐 처리량 * 평균 서비스 시간
    큐와 서비스 수행 중에 있는 평균 건수 = 평균 큐 처리량 * (평균 대기시간 * 평균 서비스 시간)
    
### 1.1.1 서비스 처리 건수 / 측정 시간(초)
가장 기초적인 공식으로 가장 많이 사용된다. 시간당 1,000,000건의 카드 승인을 처리하는 시스템이 있다면 공식은 다음과 같다.

    278TPS(소수점반올림) = 1,000,000 / 3,600(1시간 = 3,600초)
    
### 1.1.2 요청 사용자 수 / 평균 응답시간(초)
요청 사용자 수가 100명이고 평균 응답시간이 2초라면 아래 공식을 의미한다.

    50TPS = 100(명) / 2초
        
### 1.1.3 동시 사용자 수 / 서비스 요청 간격(초)
동시사용자수(요청사용자수 + 비요청사용자수) 100명이 10초마다 요청 버튼을 누르면 초당 10개의 요청이 들어오는 것이다. 즉 10TPS를 만족해야 한다.

만약 TPS가 100이고 사용자의 행동 패턴을 조사한 결과 평균 30초 마다 요청을 한다고 한다면 원할이 사용 할 수 있는 사용자 수는 3,000명을 예샹 할 수 있다.

    최대 사용자 수(동시 사용자 수) = 3000명 = 100TPS * 30초

### 1.1.4 동시 사용자 수 = TPS * 평균응답시간
WAS의 최대 Thread설정이 90개 였을때 Access Log를 분석해서 최대 스레드 스레드를 사용하는지 파악할 때 좋은 공식이다.

TPS가 10이고 평균 응답시간이 9.0일 경우 동시작업수는 10 * 9.0 = 90이다. 그렇다는 것은 현재 부하가 모든 Thread를 사용하고 잇음을 의미한다.

    /message/servlet/index.jsp
    시간    TPS     평균응답시간  동시작업수
    8:50    5.6      0.4        2.1
    8:58    8.0      2.1        17.0  
    9:02    10       8.9        90
    9:03    9.0      10.0       90 

### 1.1.5 요청 사용자 수 (동시 작업 수)

    요청사용자수 (동시 작업 수)
    = 동시 사용자 수 / 서비스 요청 간격 * 평균 응답시간
    = 동시 사용자 수 * (평균 응답시간 / (평균 응답시간 + 생각시간))
    
만약 3,000명의 동시 사용자가 있는데 평균 응답시간이 2초이며 30초마다 요청버튼을 누른다면 요청사용자 수는 200명이다. 그리고 TPS 100(200(요청사용자수) / 2초(응답시간))이다
   
### 1.1.6 응답시간 법칙(Response Time Law)

    평균응답시간(초) = (동시 사용자 수 / 처리량(TPS)) - 생각시간
    
만약 동시 사용자가 600명일 때 초당 처리량이 20TPS라면 사용자는 평균적으로 30초마다 요청을 발생 한다고 예상이 된다. 여기서 평균응답시간이 3초라면 사용자가 생각하는 시간이 평균 27초로 예상을 할 수 있다.     
    
## 1.2 사용률 이론

    단일 자원 사용률
    = 사용 시간 / 측정 시간
    = (사용 시간 / 서비스 건수) * 처리량
    = 서비스 시간 * 처리량
    
    처리량(TPS) = 서비스 건수 / 측정 시간
    서비스 시간 = 사용시간 / 서비스 건수
    
    복수 자원 사용률 = (서비스 시간 / 자원 수) * 처리량
    
예를 들어 한개의 CPU가 초당 100개씩 데이터를 처리하며 한데이터를 처리하는데 1.5ms가 걸린다면 해당 CPU의 평균 사용율을 아래와 같다.
    
    15% = 0.15 = 100 * 0.0015
    
그리고 이 CPU를 100% 사용할 경우 몇개의 데이터를 처리 할 수 있는지 계산은 다음과 같다. 
    
    666 = (100 / 15) * 100 또는
    666 = 1000(1초 1000ms) / 1.5
    
## 1.3 비율 분석 (블록)

    A 블록과 B 블록의 전체 처리량(TPS) 
    = 요청사용자수 / (A 블록의 응답시간 + B 블록의 응답시간)
    = 1/((1 / A 블록처리량) + (1 / B 블록 처리량))

    블록이 n개라면
    n개 블록의 전체 처리량(TPS) = 1/((1 / A 블록처리량) + (1 / B 블록 처리량) ... (1 / n 블록 처리량))
     
최대 120개의 thread로 동작하는 WAS안에서 평균 응답시간이 4초인 A 블록과 평균 응답시간이 2초인 B 블록이 있다고 가정하면 아래와 같다
     
    30TPS(A 블록) = 120(thread) / 4(초)
    60TPS(B 블록) = 120(thread) / 2(초)
    20TPS(A+B 블록) = 120 / (4 + 2)초
     
위 공식을 응용하면 요구되는 TPS가 있을 경우 특정 블록의 TPS의 요구치를 구할 수 있다. 30TPS 만족해야 하고 A의 블록이 60이라면 B블록은 60을 유지 해야한다.
      
    60(B블록 TPS) = 30(목표 TPS) / (1 - (1 / 60(A 블록 TPS)))    

## 1.4 비율 분석 (업무)

    A 업무와 B 업무의 전체 처리량(TPS)
    = 1 / ((A 업무의 요청 비율 / A 업무의 최대 처리량) + (B 업무의 요청 비율 / B 업무의 최대 처리량))
     
    업무가 n개 이면
    = 1 / ((A 업무의 요청 비율 / A 업무의 최대 처리량) + ... + (n 업무의 요청 비율 / n 업무의 최대 처리량))
    
A, B라는 두개의 업무가 있고 A 업무는 개별 최대 20TPS에 운영 시점에 초당 15개의 요청이 발생하고 B는 개별 최대 200TPS에 운영시 초당 5개의 요청이 발생한다고 하자 그럼 아래 처럼 계산이 된다.
    
    0.75(A의 요청 발생 비율) = 15(초당요청) / 20(총 요청건)
    0.25(B의 요청 발생 비율) = 5(초당요청) / 20(총 요청건)
     
    0.03750 (A의 발생 비율 / A의 최대처리량) = 0.75 / 20
    0.00125 (B의 발생 비율 / B의 최대처리량) = 0.25 / 200
    
    A,B 업무의 최대 처리량(TPS) 25.8 = 1 / (0.03750 + 0.00125)
    
   
    
   