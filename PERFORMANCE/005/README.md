# 상황별 분석 및 개선 방향

## 1. 클라이언트

### 1.1 클라이언트 자원 사용율 파악

    도구: procexp, precesshacker
    ----------------------------
    확인요소:
    클라이언트 여유 자원률 체크
    웹브라우저 자원 사용률 체크

### 1.2 사용자 접점 서버 패킷 수집

    수집도구: tcpdump, snoop, nettl, iptrace, wireshark
    분석도구: wireshark, Visual round Trip Analyzer
    --------------------------------------------------
    확인요소:
    IP필터링해서 서버,클라이언트간의 패킷 수집 후 클라이언트, 네트워크, 서버 처리시간 각각 분석 
 
### 1.3 클라이언트 응답시간 분석

    웹브라우저 분석 도구: F12(개발자도구), Fiddler, HttpWatch, Dynatrace AJAX Edition
    -----------------------------------------------------------------------------
    확인요소:
    과도한 서버 요청.
    잘못된 javascript 로직.
    CSS에 의한 렌더링 영향도 파악.
    javascript에 불필요한 로그 파악.
    클라이언트 캐쉬 동작여부 파악
    컨텐츠 자체의 크기.
    자원(js, image, css)등의 갯수나 용량.

### 1.4 네트워크 자원 분석

    분석 도구: Wireshark
    -------------------
    전송 데이터 크기/갯수/형태/압축여부 파악
    프로토콜, 네트워크 연결 유지 및 연결수, 네트워크 turn 갯수 확인
    통신 품질 확인 : 패킷왕복시간, 재전송여부, 전송 대역폭(Bandwidth)
    
## 2. 서버

### 2.1 어플리케이션 서버

    수집: jstack, pstack, 로그
    분석: SDPA
    ------------------------
    확인요소:
    5~10초 간격으로 스택 수집, 분석도구를 통해 어플리케이션 로직, DB, 연계 각각의 차지하는 비중 확인
    
### 2.2 채널/웹 서버
    
    웹서버 모니터링 도구, 웹서버 로그, netstat, jstack, pstack
    ------------------------------------------------------
    확인요소: 큐잉여부, 작업중인 스레드 갯수, 접속된 클라이언트 수, keep alive 여부와 설정시간
    
### 2.3 DB 서버
    
    DB모니터링 도구, SQL  확인
    -------------
    확인요소:
    현재 SQL 수행 중인 세션 상태(Wait event)
    수행중인 SQL간 Lock영향도 확인.
    저성능 SQL 실행계획 및 통계 확인
    DB 운영통계 분석
    
### 2.4 연계서버
    
    연계서버 프로세스 처리 로그, jstack, pstack
    ---------------------------------------
    확인요소:
    연계서버 처리 로그 확인.
    연계서버 스택 분석
    
### 2.5 어플리케이션
    
    APM도구, 어플리케이션로그, jstack, pstack, SDPA
    --------------------------------------------
    확인요소:
    Thread Pool/DB Pool 상태 확인(부족여부) - 자원사용률 고려.
    불필요한 작업. (로깅등)
    불필요한 로직.
    SQL 수행 패턴 분석, 잘못된 SQL
    
## 3. 자원 사용율

### 3.1 CPU 사용률 확인

    프로세스, 스레드 조회: ps, top, glance, nmon, procexp.exe
    프로세스 스택 수집: jstack, pstack
    CPU 프로파일링: perf, tprof, caliper
    시스템 모니터링: truss, tusc, strace, procmon.exe
    ------------------------------------------------------
    확인요소:
    어떤 프로세스/스레드가 CPU를 사용하는지 파악하고 스택을 통한 분석
    
### 3.2 메모리 사용률 확인

#### 3.2.1 프로세스별 메모리 사용율 측정
    
    메모리 사용량 조회: ps, top, topas, glance, nmon, svmon, pmap
    공유/큐 메모리 확인: ipcs
    파일 캐시 확인: vmstat, kcusage, free, topas, glance
    ----------------------------------------------------------
    확인요소:
    프로세스간 공유메모리 사용량이 중복 계산되지 않는것이 중요하며 프로세스가 얼마나 많은 메모리를 사용하는지 체크
    
#### 3.2.2 GC영향도 내부 메모리 사용율
    
    CG 로그 수집: GC 로그, jstat
    CG 분석: jmeter, gcviewer, 로그 수집(수작업)
    Heap 메모리 수집: jmap, kill -3, gcore
    Heap 메모리 분석: Eclipse Mat, IBM Heap analyzer
    ----------------------------------------------
    확인요소:
    GC소요시간 5%이내면 문제 없다고 판단한다.(시스템 특성에 따라 달라진다)
    물리적 메모리가 작은데 java 메모리가 필요 이상으로 크면 줄인다.(GC영양도 파악)
    어플리케이션에서 발생하는 메모리 누수 파악
    
#### 3.2.3 바이너리 메모리 누수

    디버거: wdb, libumem, valgrind, umdh
    트레이서: dtrace, probevue
    분석도구: cppCheck
    -----------------------------------
    확인요소:
    heap 메모리를 new나 malloc으로 할당후 delete나 free로 해제하지 않는 것이 메모리 누수의 원인 이런 해제안한 로직을 찾아서 수정한다.
     
### 3.3 디스크 사용율
사용하는 디스크가 DB의 tablespace인지, 어플리케이션 로그 디렉토리인지, 어플리케이션 파일 업로드/다운로드 인지에 따라 접근이 달라진다. Tablespace라면 sql을 통한 물리 사용 블록을 줄이거나 입출력이 집중되는 테이블을 각각 다른 디스크로 분산하는등의 수행. 로그면 로그량을 검토하고 파일이면 크기제약이나 파일분산 저장을 들 수 있다.
    
    분석: lsof, pfiles, truss, filemon, procexp.exe, promon.exe
    스택수집: pstack, jstack, kill -3
    분석: SDPA, 수작업
    -----------------------------------------------------------
    확인요소:
    디스크에 I/O를 발생시키는 파일 위치, 이름등을 실시간 입출력 도구를 사용하거나 스택을 분석해서 확인.
        
#### 3.3.1 메모리 부족으로 인해 swap영역 I/O급증 파악
        
    vmstat, glance, nmon, topas, top
    --------------------------------
    확인요소:
    메모리 부족으로 인해서 swap영역에 대한 입출력이 증가하는지 파악, 메모리 증설하거나 메모리 사용율을 감소하는 방안 마련.
        
## 4. 서비스 멈춤 현상
    
    처리단계:
    1. CPU, 메모리 자원사용여부 파악(DB 데이터 캐시영역이 Disk swap영역으로 넘어가는 순간 성능하락)
    2. java같은 경우 FULL GC에 멈춤 현상이 있을 수 있음, 모니터링으로 인해 파악
    3. jstack, pstack을 통한 Lock영향도나 수행기능, 작업 스레드 소진 파악
    4. 완전 멈춤인지, 너무 느린건지 파악.
    5. DB에 쿼리 질의가 느린건지, 어플리케이션의 무한 Loop 발생인지 확인.
    
## 5. 전반적 성능 개선
    
    가장 비중이 높은 어플리케이션 로직과 DB의 SQL질의 확인.
    APM이나 DB모니터링 툴을 사용해 확인.
    
## 6. 개선방안
   
### 6.1 병렬/분산처리
   
    프론트 작업을 병렬 처리 가능한가?
    어플리케이션 작업을 병렬 처리 가능한가?
    웹서버, Was의 작업 thread Pool과 Db Connection Pool등 병렬 자원을 늘릴수 있는가?
    트랜잭션이 집중되는 테이블은 파티션으로 분산할 수 있는가?
    DB를 샤딩해서 요청을 분산할 수 있는가?
    파일 I/O를 분산해 병렬 처리할 수 있는가?
    
### 6.2 비동기
    
    Front에서 처리시간이 긴것을 비동기로 처리가 가능한가?
    필수 작업이 아닌 작업들을 비동기로 처리가 가능한가?
    자원(CSS, js등)을 비동기 처리 가능한가?
    
### 6.3 캐쉬
    
    반복되는 DB조회 결과를 캐쉬 할 수 있는가?
    반복되는 계산 값을 캐쉬 할 수 있는가?
    FrameWork와 Application 로직에서 사용하는 기초 데이터들이 캐쉬 되었는가?
    변경주기가 길고 빈도는 낮은 서비스들을 캐쉬할 수 있는가?
    화면 컨텐츠 변경이 빈번하지 않을 경우 캐쉬 할 수 있는가?
    
### 6.4 집합 처리
    
    처리건수가 큰 DML은 묶어서 처리하는가?
    DB Fetch 건수는 적절한가?
    파일을 읽고 쓸 때 레코드 단위로 처리하는가?
    네트워크 데이터는 대량으로 송수신하는가?
    웹 화면에서 HTTP요청 수를 줄일 수 있는가?
    
### 6.5 오버헤드 제거
    
    어플리케이션 로직이 최적화 되었는가?
    불필요한 쿼리, 로직이 있는가?
    필요이상의 DB데이터를 조회 하는가?
    스레드간에 반복 수행되는 기능을 제거 가능한가?
    필요이상으로 크게 설정된 자원을 줄일 수 있는가?
    
### 6.6 경합 제거
    
    베타적으로 Lock을 획득해서 수행하는 코드는 lock 범위가 필요한 부분만으로 최소화 되어있는가?
    업무 처리 단계에서 DB lock을 최소화 하도록 경합 DML이 로직 뒤에 위치하는가?
    로그 파일에 경합이 발생하는가?
    
### 6.7 SQL 개선

    plan은 적절한가? (적절한 index 사용? full search하는가?)
    주기적으로 Table 통계가 갱신되고 확인할 수 있는가?
    SQL 바인드 변수 처리는 잘되어 있는가?
    

### 6.8 송수신 효율화

    송수신 전문들은 네트워크 특성을 통해 적절한 크기를 가지는가?
    요청 수를 최대한 줄일수 잇는가?
    압축이 가능한가?
    네트워크 전송품질(RTT, 재전송발생)을 개선가능한가?
    
### 6.9 자원 사용 효율화
    
    CPU를 많이 잡아먹는 함수를 개선 가능한가?
    메모리 사용율을 줄일 수 있는가?
    불필요한 파일 I/O를 줄일 수 잇는가?
    메모리 누수는 없에야 한다!
    Java GC를 효율적으로 수행 할 수 있는가?
    Java GC를 효율적으로 수행하기 위해 메모리 사용 패턴을 개선 할 수 있는가?
    
### 6.10 물리적 자원 증설
    
    CPU, 메모리, 디스크등 자원을 증설 가능한가?
    고성능 스토리지로 변경 가능한가?
    스토리지와 서버간 I/O개선을 위해 채널 수를 늘릴 필요가 있는가?
    네트워크 대역폭은 여유가 있는가?
    
    
    
    
     











 

